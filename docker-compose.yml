# version: '3.8'

# services:
#   couchdb:
#     image: couchdb:latest
#     container_name: couchdb
#     ports:
#       - "5984:5984"
#     environment:
#       COUCHDB_USER: app
#       COUCHDB_PASSWORD: app
#     volumes:
#       - couchdb_data:/opt/couchdb/data

#   frontend:
#     build:
#       context: .
#       dockerfile: Dockerfile
#     container_name: geology_frontend
#     ports:
#       - "3000:80"
#     depends_on:
#       - couchdb

# volumes:
#   couchdb_data:

services:
  couchdb:
    image: couchdb:latest
    container_name: couchdb
    restart: always
    environment:
      - COUCHDB_USER=app
      - COUCHDB_PASSWORD=app
    # Developer only: CouchDB on localhost so only you can connect (e.g. Fauxton, curl).
    # Students and outsiders cannot reach this; professor uses Admin in the app.
    ports:
      - "127.0.0.1:5984:5984"
    volumes:
      # Persist CouchDB data in a folder on the host machine
      - ./couchdb/data:/opt/couchdb/data
    command: >
      bash -c "
        echo '[couchdb]\nsingle_node=true\n' > /opt/couchdb/etc/local.d/docker.ini &&
        echo '[chttpd]\nrequire_valid_user = true\n' >> /opt/couchdb/etc/local.d/docker.ini &&
        echo '[cors]\nenabled = true\n' >> /opt/couchdb/etc/local.d/docker.ini &&
        echo '[cors]\norigins = *\nmethods = GET, PUT, POST, DELETE, OPTIONS\nheaders = accept, authorization, content-type, origin, referer\n' >> /opt/couchdb/etc/local.d/docker.ini &&
        /docker-entrypoint.sh /opt/couchdb/bin/couchdb &
        sleep 10 &&
        curl -u app:app -X PUT http://127.0.0.1:5984/geology-data || echo 'Database may already exist' &&
        wait
      "

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: geology_frontend
    ports:
      - "3000:80"
    depends_on:
      - couchdb
